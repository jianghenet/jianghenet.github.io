<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monty Hall Problem</title>
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: auto auto auto;
      padding: 10px;
    }
    .grid-item {
      padding: 20px;
      font-size: 30px;
      text-align: center;
    }
    #puzzle > th,td {
      width: 180px;
    }
    #puzzle > tbody td {
      height: 180px;
    }
    #puzzle > tbody td.mystery::after{
      content: "ğŸšª";
      font-size: 130px;
    }
    #puzzle > tbody td.show-0::after{
      content: "ğŸ";
      font-size: 130px;
    }
    #puzzle > tbody td.show-1::after{
      content: "ğŸï¸";
      font-size: 130px;
    }
    input[type=radio]{
      width: 36px;
      height: 36px;
    }
    div#result-counts {
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="grid-container">
    <div class="grid-item">
      <table id="puzzle">
        <thead>
          <tr>
            <th>
              <label for="choices0">1å·é—¨</label>
            </th>
            <th>
              <label for="choices1">2å·é—¨</label></th>
            </th>
            <th>
              <label for="choices2">3å·é—¨</label></th>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td><input type="radio" name="choices" onchange="onOptionsClick(this)" id="choices0" value="0"/></td>
            <td><input type="radio" name="choices" onchange="onOptionsClick(this)" id="choices1" value="1"></td>
            <td><input type="radio" name="choices" onchange="onOptionsClick(this)" id="choices2" value="2"></td>
          </tr>
        </tfoot>
      </table>
      <div><button onclick="massAutoPlay(1000)"> è‡ªåŠ¨è¿è¡Œ 1000 æ¬¡</button></div>
      <div id="new-bu-wrapper"><button id="new-game-btn" onclick="makePuzzleVisualize()">æ–°å¼€å±€</button></div>
      <div id="open-door-wrapper" style="display:none"><button id="open-door-btn" onclick="hostOpenDoor()">ä¸»æŒäººå¼€é—¨</button></div>
      <div id="make-result-wrapper" style="display:none"><button id="no-change-btn" onclick="noChangeChoice()">ä¸æ¢é—¨</button> <button id="change-btn" onclick="changeChoice()">æ¢é—¨</button></div>
    </div>
    <div class="grid-item"><div id="result-counts"></div></div>
  </div>
  <div>
    <h4>Tip</h4>
    <p>
      å½“æ¢é—¨æ—¶ï¼Œæ¸¸æˆå‘ç”Ÿäº†æ”¹å˜ã€‚æ¸¸æˆçš„å‘½ä¸­æ¦‚ç‡å®šä¹‰æ”¹å˜ä¸ºï¼šä»3ä¸ªé€‰é¡¹ä¸­ä»»é€‰2ä¸ªï¼Œå…¶ä¸­<b>ä»»ä¸€</b>é€‰é¡¹å‘½ä¸­çš„æ¦‚ç‡ã€‚ç»„åˆä¸ºï¼š0+0ï¼Œ0+1ï¼Œ1+0ï¼›å‡ºç°1çš„æ¦‚ç‡ä¸º2/3ã€‚
      <br/>
      å¦‚æœä¸æ¢ï¼Œæ¸¸æˆä¿æŒæ¦‚ç‡ä¸å˜ï¼šä»3ä¸ªé€‰é¡¹ä¸­é€‰æ‹©1ä¸ªï¼Œé€‰é¡¹å‘½ä¸­çš„æ¦‚ç‡ã€‚ç»„åˆä¸º0, 1, 0ï¼›å‡ºç°1çš„æ¦‚ç‡ä¸º1/3ã€‚
      <br/>
      ä¸»æŒäººå¼€é—¨æ”¹å˜æ¸¸æˆçš„è§„åˆ™åï¼Œæ•´ä½“æ¦‚ç‡ä»3é€‰ä¸€ï¼Œå˜ä¸º2é€‰ä¸€ã€‚ä»ç»“æœå¯è§æ•´ä½“æ¦‚ç‡ä¸º1/2ã€‚
      <br/>
      ç»¼ä¸Šå¯çŸ¥ï¼Œåº”è¯¥æ¢é—¨ã€‚
    </p>
  </div>

  <script>

    class MontyHallGame{
      constructor(){
        this.player = new Player(this.puzzle);
        this.hoster = new Hoster(this.puzzle);
        this.gameActived = false;
      }

      reset(){
        this.puzzle = [0,0,1].sort(()=>Math.random()-0.5);
        this.carIndex = this.puzzle.indexOf(1);
        this.player.reset(this.puzzle);
        this.hoster.reset(this.puzzle);
        this.gameActived = true;
      }

      complete(){
        this.gameActived = false;
      }

      playerChose(){
        this.player.chose();
      }

      playerChange(){
        this.player.change(this.openDoorIndex);
      }

      isPlayerWin(){
        return this.player.chosedIdx == this.carIndex;
      }

      openDoor(){
        this.openDoorIndex = this.hoster.openDoor(this.player.chosedIdx, this.carIndex);
      }
    }

    class Player{
      constructor(puzzle){
        this.puzzle = puzzle;
      }
      reset(puzzle){
        this.puzzle = puzzle;
        this.chosedIdx = null;
        this.oldChoseIdx = null;
        this.chosedIdxChanged = null;
      }

      setChosedIdx(idx){
        this.oldChoseIdx = this.chosedIdx;
        this.chosedIdx = idx;
        this.chosedIdxChanged == !(this.oldChoseIdx == this.chosedIdx);
      }

      chose(){
        let idx = Math.floor(this.puzzle.length * Math.random());
        this.chosedIdx = idx;
        return idx;
      }

      isChanged(){
        return this.chosedIdxChanged;
      }

      noChange(){
      }

      change(hostOpenIndex){
        let otherIdx = this.puzzle.findIndex((_val, idx)=>{
          return (idx != this.chosedIdx && idx != hostOpenIndex)
        })
        this.oldChoseIdx = this.chosedIdx;
        this.chosedIdx = otherIdx;
        this.chosedIdxChanged = !(this.oldChoseIdx == this.chosedIdx);
      }
    }

    class Hoster{
      constructor(puzzle){
        this.puzzle = puzzle;
      }

      reset(puzzle){
        this.puzzle = puzzle;
        this.openDoorIndex = null;
      }

      openDoor(chosedIdx, carIndex){
        let hostOptions = [];
        this.puzzle.forEach((_val, idx) => {
          if(idx != chosedIdx && idx != carIndex){
            hostOptions.push(idx);
          }
        });
        let idx = hostOptions[Math.floor(hostOptions.length * Math.random())];
        this.openDoorIndex = idx;
        return idx;
      }
    }

    var counts = {
      all: 0,
      changed: 0,
      noChanged: 0,
      changedWin: 0,
      noChangedWin: 0
    }

    function makeGameCount(){
      counts.all = counts.all + 1;
      if(montyHallGame.player.isChanged()){
        counts.changed = counts.changed + 1;
        if(montyHallGame.isPlayerWin()){
          counts.changedWin = counts.changedWin + 1;
        }
      }else{
        counts.noChanged = counts.noChanged + 1;
        if(montyHallGame.isPlayerWin()){
          counts.noChangedWin = counts.noChangedWin + 1;
        }
      }
    }


    var montyHallGame = new MontyHallGame();
    function puzzleTd(doorNum){
      return `<td id="door-${doorNum}" class="mystery"></td>`
    }
    function puzzleHtmlTemplate(){
      return `<tr>
          ${puzzleTd(0)}
          ${puzzleTd(1)}
          ${puzzleTd(2)}
        </tr>`;
    }

    function makePuzzleVisualize(){
      montyHallGame.reset()
      document.querySelector("#puzzle tbody").innerHTML = puzzleHtmlTemplate();
      document.getElementById("new-bu-wrapper").style.display = 'none';
      document.getElementById("make-result-wrapper").style.display = 'none';
      document.getElementById("open-door-wrapper").style.display = 'block';
      document.getElementsByName('choices').forEach((t)=>t.checked=false);
    }

    function onOptionsClick(input){
      montyHallGame.player.setChosedIdx(input.value);
    }

    function hostOpenDoor(){
      if(!montyHallGame.gameActived){
        alert("æ¸¸æˆç»“æŸï¼Œè¯·æ–°å¼€ä¸€è½®");
        return;
      }
      let choiceInput = document.querySelector("[name=choices]:checked");
      if(choiceInput){
        montyHallGame.openDoor();
        let td = document.getElementById(`door-${montyHallGame.openDoorIndex}`);
        td.classList.remove("mystery");
        td.classList.add('show-0');
        document.getElementById("make-result-wrapper").style.display = 'block';
      }else{
        alert("éœ€è¦æŒ‡å®šä¸€ä¸ªé€‰é¡¹")
      }
    }

    function showAnswer(){
      if(!montyHallGame.gameActived){
        alert("æ¸¸æˆç»“æŸï¼Œè¯·æ–°å¼€ä¸€è½®");
        return;
      }
      let choiceInput = document.querySelector("[name=choices]:checked");
      if(!choiceInput){
        alert("éœ€è¦æŒ‡å®šä¸€ä¸ªé€‰é¡¹")
        return false;
      }
      montyHallGame.puzzle.forEach((element, idx) => {
        if(element==0){
          document.getElementById(`door-${idx}`).className = "show-0"
        }else{
          document.getElementById(`door-${idx}`).className = "show-1"
        }
      });
      document.getElementById("new-bu-wrapper").style.display = 'block';
      montyHallGame.gameActived = false;
      showCounts();
    }

    function changeChoice(){
      if(!montyHallGame.gameActived){
        alert("æ¸¸æˆç»“æŸï¼Œè¯·æ–°å¼€ä¸€è½®");
        return;
      }
      let choiceInput = document.querySelector("[name=choices]:checked");
      if(choiceInput){
        montyHallGame.playerChange();
        document.getElementById(`choices${montyHallGame.player.chosedIdx}`).click();
        makeGameCount();
        showAnswer();
      }else{
        alert("éœ€è¦æŒ‡å®šä¸€ä¸ªé€‰é¡¹")
      }
    }

    function noChangeChoice(){
      if(!montyHallGame.gameActived){
        alert("æ¸¸æˆç»“æŸï¼Œè¯·æ–°å¼€ä¸€è½®");
        return;
      }
      let choiceInput = document.querySelector("[name=choices]:checked");
      if(!choiceInput){
        alert("éœ€è¦æŒ‡å®šä¸€ä¸ªé€‰é¡¹")
        return false;
      }
      makeGameCount();
      showAnswer();
    }

    function showCounts(){
      let resultHtml = `
      <p>æ€»æ¬¡æ•°:${counts.all}</p>
      <p>æ€»èµ¢æ•°: ${counts.changedWin + counts.noChangedWin}((${counts.all > 0 ? ((counts.changedWin + counts.noChangedWin)/counts.all).toFixed(3) : '-'}))</p>
      <p>æ¢é—¨æ•°: ${counts.changed}</p>
      <p>æ¢é—¨èµ¢: ${counts.changedWin}(${counts.changed > 0 ? (counts.changedWin/counts.changed).toFixed(3) : '-'})</p>
      <p>ä¸æ¢æ•°: ${counts.noChanged}</p>
      <p>ä¸æ¢èµ¢: ${counts.noChangedWin}(${counts.noChanged > 0 ? (counts.noChangedWin/counts.noChanged).toFixed(3) : '-'})</p>
      `;
      document.getElementById("result-counts").innerHTML = resultHtml;
    }

    async function sleep(time) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, time);
      });
    }

    async function massAutoPlay(num=100){
      for(let i = 0;i<num; i++){
        autoPlay();
        await sleep(10);
        showCounts();
      }

    }

    function autoPlay(){
      montyHallGame.reset();
      montyHallGame.playerChose();
      montyHallGame.openDoor();
      if(Math.random() > 0.39999){
        montyHallGame.playerChange();
      }
      montyHallGame.gameActived=false;
      //console.log(`${+(new Date())}#>è°œåº•: ${montyHallGame.carIndex}, èµ¢:${montyHallGame.isPlayerWin()}, æ˜¯å¦æ¢é—¨ï¼š${montyHallGame.player.isChanged()}, æœ€ç»ˆç­”æ¡ˆï¼š${montyHallGame.player.chosedIdx}, å¼€å§‹é€‰æ‹©ï¼š${montyHallGame.player.oldChoseIdx}`)

      makeGameCount();
    }
  </script>
</body>
</html>